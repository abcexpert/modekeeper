#!/usr/bin/env bash
set -Eeuo pipefail

usage() {
  cat <<'USAGE'
usage: ./bin/mk-enterprise-eval

Run one-command enterprise evaluation workflow.
Generates procurement artifacts and writes an evaluation index at:
report/enterprise_eval/index.md
USAGE
}

if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

if [[ $# -ne 0 ]]; then
  echo "ERROR: unknown argument(s): $*" >&2
  usage >&2
  exit 2
fi

REPO="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO"

OUT_DIR="report/enterprise_eval"
INDEX="$OUT_DIR/index.md"
PROC_ROOT="report/procurement_pack"
TARBALL="$PROC_ROOT/procurement_pack.tar.gz"
CHECKSUMS="$PROC_ROOT/checksums.sha256"
BUYER_ROOT="$PROC_ROOT/buyer_pack"

echo "[1/3] generate procurement pack"
./bin/mk-procurement-pack

require_file() {
  local path="$1"
  if [[ ! -f "$path" ]]; then
    echo "ERROR: expected file is missing: $path" >&2
    exit 2
  fi
}

require_file "$TARBALL"
require_file "$CHECKSUMS"
require_file "$BUYER_ROOT/plan/closed_loop_latest.json"
require_file "$BUYER_ROOT/verify/k8s_verify_latest.json"
require_file "$BUYER_ROOT/dryrun/closed_loop_latest.json"
require_file "$BUYER_ROOT/dryrun/k8s_plan.json"

echo "[2/3] write enterprise evaluation index"
mkdir -p "$OUT_DIR"
cat >"$INDEX" <<EOF
# Enterprise Evaluation Index

Generated by: \`./bin/mk-enterprise-eval\`

## Procurement bundle

- Tarball: \`$TARBALL\`
- Checksums: \`$CHECKSUMS\`

## Verify checksums

\`\`\`bash
cd $PROC_ROOT && sha256sum -c checksums.sha256
\`\`\`

## Key JSON artifacts to inspect

- \`$BUYER_ROOT/plan/closed_loop_latest.json\` (gate outcomes summary, including \`verify_ok\`)
- \`$BUYER_ROOT/verify/k8s_verify_latest.json\` (verify report with \`ok\` and \`verify_blocker\`)
- \`$BUYER_ROOT/dryrun/closed_loop_latest.json\` (closed-loop dry-run decision summary)
- \`$BUYER_ROOT/dryrun/k8s_plan.json\` (rendered non-mutating plan evidence)

## Docs included in pack

- \`$PROC_ROOT/docs/SECURITY_POSTURE.md\`
- \`$PROC_ROOT/docs/SECURITY_QA.md\`
- \`$PROC_ROOT/docs/COMPLIANCE_MATRIX.md\`
- \`$PROC_ROOT/docs/THREAT_MODEL.md\`
- \`$PROC_ROOT/docs/WORKFLOW.md\`
- \`$PROC_ROOT/docs/RELEASE.md\`
- \`$PROC_ROOT/docs/DISTRIBUTION_POLICY.md\`
EOF

echo "[3/3] done"
echo "OK: Enterprise evaluation index written to $INDEX"
